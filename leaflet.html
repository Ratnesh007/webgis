<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Map with WMS Capabilities, Legends & Identify</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #sidebar {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 320px;
      max-height: 90%;
      overflow: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: transform .3s ease;
      z-index: 1000;
    }
    #sidebar.collapsed {
      transform: translateX(100%);
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      right: 340px;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      z-index: 1001;
    }
    .layer-toggle, .section {
      margin-bottom: 10px;
    }
    #wmsLegendContainer img {
      margin-top: 5px;
      display: block;
      max-width: 100%;
      border: 1px solid #ccc;
    }
    .layer-control-btn {
      margin-left: 5px;
      padding: 2px 5px;
      font-size: 0.8em;
      cursor: pointer;
      border: 1px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 3px;
    }
    .layer-control-btn:hover {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>

<button id="toggleSidebar">‚ò∞ Layers</button>

<div id="sidebar" class="collapsed">
  <strong>Built-in Layers</strong>
  <div class="layer-toggle">
    <input type="checkbox" id="layerA" checked>
    <label for="layerA">Layer A (Circle)</label>
  </div>
  <div class="layer-toggle">
    <input type="checkbox" id="layerB" checked>
    <label for="layerB">Layer B (Marker)</label>
  </div>

  <div class="section">
    <strong>WMS Service</strong><br>
    <input type="text" id="wmsCapabilitiesUrl" placeholder="WMS GetCapabilities URL" style="width:100%; margin-bottom:5px;" />
    <button onclick="fetchWMSLayers()">Fetch Layers</button>
    <select id="wmsLayerSelect" disabled style="width:100%; margin-top:5px;"></select>
    <button id="addFromSelect" onclick="addWMSFromSelect()" disabled style="width:100%; margin-top:5px;">Add Selected WMS Layer</button>
  </div>

  <div id="dynamicLayerToggles" class="section">
    <strong>Dynamic WMS Layers</strong>
  </div>

  <div id="wmsLegends" class="section">
    <strong>WMS Legends</strong>
    <div id="wmsLegendContainer"></div>
  </div>

  <hr>

  <strong>Legend</strong>
  <div style="margin-top:5px;">
    <div><span style="background:red; width:12px; height:12px; display:inline-block; margin-right:5px;"></span>Layer A (Circle)</div>
    <div><span style="background:blue; width:12px; height:12px; display:inline-block; margin-right:5px;"></span>Layer B (Marker)</div>
  </div>
</div>

<div id="map"></div>

<script>
  const map = L.map('map').setView([20.5, 78.9], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const layerA = L.circle([20, 78], {
    radius: 50000,
    color: 'red',
    fillColor: 'red',
    fillOpacity: 0.5
  }).addTo(map);

  const layerB = L.marker([21, 79]).addTo(map);

  const dynamicLayers = {};
  const dynamicLegends = {};
  const dynamicLayerBounds = {};

  document.getElementById('layerA').addEventListener('change', e => {
    e.target.checked ? map.addLayer(layerA) : map.removeLayer(layerA);
  });

  document.getElementById('layerB').addEventListener('change', e => {
    e.target.checked ? map.addLayer(layerB) : map.removeLayer(layerB);
  });

  document.getElementById('toggleSidebar').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('collapsed');
  });

  async function fetchWMSLayers() {
    const url = document.getElementById('wmsCapabilitiesUrl').value.trim();
    if (!url) return alert('Enter the full GetCapabilities URL');

    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);

      const text = await resp.text();
      const xml = new DOMParser().parseFromString(text, 'application/xml');

      if (xml.querySelector('parsererror')) throw new Error('Error parsing XML');

      const layers = [];
      function extractLayers(layerElem) {
        const childLayers = layerElem.querySelectorAll(':scope > Layer');
        if (childLayers.length === 0) {
          const nameElem = layerElem.querySelector(':scope > Name');
          if (nameElem && nameElem.textContent) {
            let bbox = null;

            const llbbox = layerElem.querySelector(':scope > LatLonBoundingBox');
            if (llbbox) {
              bbox = [
                [parseFloat(llbbox.getAttribute('miny')), parseFloat(llbbox.getAttribute('minx'))],
                [parseFloat(llbbox.getAttribute('maxy')), parseFloat(llbbox.getAttribute('maxx'))]
              ];
            } else {
              const exbbox = layerElem.querySelector(':scope > EX_GeographicBoundingBox');
              if (exbbox) {
                bbox = [
                  [parseFloat(exbbox.querySelector('southBoundLatitude').textContent), parseFloat(exbbox.querySelector('westBoundLongitude').textContent)],
                  [parseFloat(exbbox.querySelector('northBoundLatitude').textContent), parseFloat(exbbox.querySelector('eastBoundLongitude').textContent)]
                ];
              }
            }

            layers.push({
              name: nameElem.textContent,
              bbox: bbox
            });
          }
        } else {
          childLayers.forEach(cl => extractLayers(cl));
        }
      }

      const rootLayers = xml.querySelectorAll('Layer');
      rootLayers.forEach(rl => extractLayers(rl));

      if (layers.length === 0) throw new Error('No layers found');

      const sel = document.getElementById('wmsLayerSelect');
      sel.innerHTML = '<option value="">-- select layer --</option>';
      layers.forEach(({ name }) => sel.add(new Option(name, name)));
      sel.disabled = false;

      window.fetchedWMSLayers = {};
      layers.forEach(l => window.fetchedWMSLayers[l.name] = l);

      const addBtn = document.getElementById('addFromSelect');
      sel.onchange = () => {
        addBtn.disabled = !sel.value;
      };
      addBtn.disabled = true;

      alert(`${layers.length} layers found`);
    } catch (err) {
      console.error(err);
      alert('Error fetching/parsing WMS GetCapabilities. ' + err.message);
    }
  }

  function addWMSFromSelect() {
    const url = document.getElementById('wmsCapabilitiesUrl').value.trim();
    const layerName = document.getElementById('wmsLayerSelect').value;
    if (!url || !layerName) return;

    const key = `WMS:${layerName}`;
    if (dynamicLayers[key]) return alert('Layer already added');

    const baseUrl = url.split('?')[0];
    const wmsLayer = L.tileLayer.wms(baseUrl, {
      layers: layerName,
      format: 'image/png',
      transparent: true,
      version: '1.1.1',
      attribution: 'WMS Layer'
    }).addTo(map);

    dynamicLayers[key] = wmsLayer;

    if (window.fetchedWMSLayers && window.fetchedWMSLayers[layerName]?.bbox) {
      dynamicLayerBounds[key] = window.fetchedWMSLayers[layerName].bbox;
    }

    addDynamicToggle(key, wmsLayer);
    addWMSLegend(key, baseUrl, layerName);
  }

  function addDynamicToggle(name, layer) {
    const container = document.createElement('div');
    container.className = 'layer-toggle';
    const id = `toggle-${name}`;

    container.innerHTML = `
      <input type="checkbox" id="${id}" checked>
      <label for="${id}" style="margin-right:5px;">${name}</label>
      <button class="layer-control-btn" title="Zoom to Layer">üîç</button>
      <button class="layer-control-btn" title="Remove Layer">‚úñ</button>
    `;

    document.getElementById('dynamicLayerToggles').appendChild(container);

    document.getElementById(id).addEventListener('change', e => {
      e.target.checked ? map.addLayer(layer) : map.removeLayer(layer);
    });

    container.querySelector("button[title='Zoom to Layer']").addEventListener('click', () => {
      zoomToWMSLayer(layer);
    });

    container.querySelector("button[title='Remove Layer']").addEventListener('click', () => {
      map.removeLayer(layer);
      delete dynamicLayers[name];
      delete dynamicLayerBounds[name];
      container.remove();
      removeWMSLegend(name);
    });
  }

  function zoomToWMSLayer(layer) {
    const key = Object.keys(dynamicLayers).find(k => dynamicLayers[k] === layer);
    if (key && dynamicLayerBounds[key]) {
      const bounds = dynamicLayerBounds[key];
      map.fitBounds(bounds);
    } else {
      map.fitBounds([[-90, -180], [90, 180]]);
      alert('Zoomed to full world extent.');
    }
  }

  function addWMSLegend(name, baseUrl, layerName) {
    const legendUrl = `${baseUrl}?service=WMS&version=1.1.1&request=GetLegendGraphic&format=image/png&layer=${layerName}`;
    const container = document.getElementById('wmsLegendContainer');

    const legendDiv = document.createElement('div');
    legendDiv.id = `legend-${name}`;
    legendDiv.style.marginBottom = '10px';
    legendDiv.innerHTML = `
      <div><strong>${layerName}</strong></div>
      <img src="${legendUrl}" alt="Legend for ${layerName}" />
    `;
    container.appendChild(legendDiv);

    dynamicLegends[name] = legendDiv;
  }

  function removeWMSLegend(name) {
    if (dynamicLegends[name]) {
      dynamicLegends[name].remove();
      delete dynamicLegends[name];
    }
  }

  // Identify feature on map click
  map.on('click', function (e) {
    const activeWMSLayers = Object.entries(dynamicLayers).filter(([_, layer]) => map.hasLayer(layer));
    if (activeWMSLayers.length === 0) return alert("No active WMS layers to identify.");

    const identifyResults = [];

    activeWMSLayers.forEach(([key, layer]) => {
      const url = getFeatureInfoUrl(map, layer, e.latlng);
      if (!url) return;

      fetch(url)
        .then(resp => resp.text())
        .then(data => {
          identifyResults.push(`<h4>${key}</h4><pre>${data}</pre>`);
          if (identifyResults.length === activeWMSLayers.length) {
            L.popup()
              .setLatLng(e.latlng)
              .setContent(identifyResults.join('<hr>'))
              .openOn(map);
          }
        })
        .catch(err => {
          console.error('Identify error:', err);
        });
    });
  });

  function getFeatureInfoUrl(map, layer, latlng) {
    const wmsParams = layer.wmsParams;
    const baseUrl = layer._url;

    const point = map.latLngToContainerPoint(latlng, map.getZoom());
    const size = map.getSize();

    const params = {
      request: 'GetFeatureInfo',
      service: 'WMS',
      srs: 'EPSG:4326',
      styles: wmsParams.styles,
      transparent: wmsParams.transparent,
      version: wmsParams.version,
      format: wmsParams.format,
      bbox: map.getBounds().toBBoxString(),
      height: size.y,
      width: size.x,
      layers: wmsParams.layers,
      query_layers: wmsParams.layers,
      info_format: 'text/plain'
    };

    if (wmsParams.version === '1.3.0') {
      params.crs = 'EPSG:4326';
      params.i = Math.round(point.x);
      params.j = Math.round(point.y);
    } else {
      params.x = Math.round(point.x);
      params.y = Math.round(point.y);
    }

    const queryString = new URLSearchParams(params).toString();
    return `${baseUrl}?${queryString}`;
  }
</script>

</body>
</html>
